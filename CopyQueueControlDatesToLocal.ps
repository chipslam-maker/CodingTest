-- 請在你的本地 (Local) SQL Server 目標資料庫中執行

CREATE TABLE dbo.QueueControlDates_Consolidated (
    -- 1. 你的新欄位：自動遞增的 SEQUENCE
    Sequence INT IDENTITY(1,1) PRIMARY KEY, 
    
    -- 來源表格的欄位
    src NVARCHAR(255) NOT NULL,
    tablename NVARCHAR(255) NOT NULL,
    lastprocessingdatetime DATETIME NOT NULL,
    
    -- 2. 你的新欄位：資料插入時間
    data_inserttime DATETIME DEFAULT GETDATE() NOT NULL 
);

-- 為了方便查詢，你可能需要一個非叢集索引
CREATE NONCLUSTERED INDEX IX_QueueControlDates_Consolidated_SrcTable
ON dbo.QueueControlDates_Consolidated (src, tablename);


# 設定變數
# -----------------------------------------------------------
$LocalServer = "你的本地伺服器名稱\實例名稱"  # 例如："(local)\SQLEXPRESS" 或 "MyLocalServer"
$LocalDB = "你的目標資料庫名稱"          # 例如："MonitoringDB"
$DestTable = "QueueControlDates_Consolidated"

# 你的兩個來源伺服器列表
$RemoteServers = @(
    @{ ServerName = "SOURCE_SERVER_A"; DatabaseName = "YourRemoteDBName" },
    @{ ServerName = "SOURCE_SERVER_B"; DatabaseName = "YourRemoteDBName" }
)

# 從來源提取資料的 T-SQL 查詢
$Query = "SELECT src, tablename, lastprocessingdatetime FROM dbo.QueueControlDates"

# 本地插入的 T-SQL 語句 (Sequence 和 data_inserttime 會自動生成)
$InsertSql = "INSERT INTO dbo.$DestTable (src, tablename, lastprocessingdatetime) VALUES (@src, @table, @time)"

# -----------------------------------------------------------

# 建立本地伺服器連線物件
$LocalConn = New-Object System.Data.SqlClient.SqlConnection
$LocalConn.ConnectionString = "Server=$LocalServer;Database=$LocalDB;Integrated Security=True;" # 假設使用 Windows 驗證

try {
    $LocalConn.Open()
    
    foreach ($Remote in $RemoteServers) {
        Write-Host "--- Processing $($Remote.ServerName) ---"
        
        # 1. 從遠程伺服器提取資料
        try {
            # 使用 Invoke-Sqlcmd 提取資料 (需要 SQL Server PowerShell 模組)
            $Data = Invoke-Sqlcmd -ServerInstance $Remote.ServerName -Database $Remote.DatabaseName -Query $Query -ErrorAction Stop
        }
        catch {
            Write-Error "Error fetching data from $($Remote.ServerName): $($_.Exception.Message)"
            continue # 跳過此伺服器，繼續下一個
        }

        # 2. 準備本地插入指令
        $LocalCmd = New-Object System.Data.SqlClient.SqlCommand
        $LocalCmd.Connection = $LocalConn
        $LocalCmd.CommandText = $InsertSql
        
        # 定義參數
        $LocalCmd.Parameters.Add((New-Object System.Data.SqlClient.SqlParameter -ArgumentList "@src", [System.Data.SqlDbType]::NVarChar, 255)) | Out-Null
        $LocalCmd.Parameters.Add((New-Object System.Data.SqlClient.SqlParameter -ArgumentList "@table", [System.Data.SqlDbType]::NVarChar, 255)) | Out-Null
        $LocalCmd.Parameters.Add((New-Object System.Data.SqlClient.SqlParameter -ArgumentList "@time", [System.Data.SqlDbType]::DateTime)) | Out-Null
        
        $RowCount = 0
        
        # 3. 執行插入操作
        foreach ($Row in $Data) {
            $LocalCmd.Parameters["@src"].Value = $Row.src
            $LocalCmd.Parameters["@table"].Value = $Row.tablename
            $LocalCmd.Parameters["@time"].Value = $Row.lastprocessingdatetime
            
            $LocalCmd.ExecuteNonQuery() | Out-Null
            $RowCount++
        }
        
        Write-Host "Successfully inserted $RowCount rows from $($Remote.ServerName)."
    }
}
catch {
    Write-Error "Database connection or execution failed: $($_.Exception.Message)"
}
finally {
    # 關閉連線
    if ($LocalConn -ne $null -and $LocalConn.State -eq [System.Data.ConnectionState]::Open) {
        $LocalConn.Close()
    }
}

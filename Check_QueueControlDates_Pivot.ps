-- 請在你的本地 (Local) SQL Server 目標資料庫中執行

CREATE TABLE dbo.QueueControlDates_History (
    -- 1. 你的新欄位：自動遞增的 SEQUENCE (SEQ)，作為主鍵
    SEQ INT IDENTITY(1,1) PRIMARY KEY, 
    
    -- 2. 共享的識別欄位
    tablename NVARCHAR(255) NOT NULL,
    src NVARCHAR(255) NOT NULL,
    
    -- 3. 重塑後的處理時間欄位
    SOURCE_DB_A_lastprocessingdatetime DATETIME NULL, 
    SOURCE_DB_B_lastprocessingdatetime DATETIME NULL, 
    
    -- 4. 插入時間 (insertdatetime)
    insertdatetime DATETIME DEFAULT GETDATE() NOT NULL
    
    -- *** 注意: 這裡不再有 UNIQUE 約束 ***
);

# 設定同步間隔 (單位：秒)
$SleepSeconds = 300 

# 設定資料庫連線變數
# -----------------------------------------------------------
$LocalServer = "你的本地伺服器名稱\實例名稱" 
$LocalDB = "你的目標資料庫名稱"          
$DestTable = "QueueControlDates_History" # <<-- 使用新的表格名稱

# 你的兩個來源伺服器列表 (請替換實際名稱和資料庫名稱)
$RemoteServers = @(
    @{ ServerName = "SOURCE_SERVER_A"; DatabaseName = "DB_NAME_A"; PivotColumn = "SOURCE_DB_A_lastprocessingdatetime" }, 
    @{ ServerName = "SOURCE_SERVER_B"; DatabaseName = "DB_NAME_B"; PivotColumn = "SOURCE_DB_B_lastprocessingdatetime" }
)

# 從來源提取資料的 T-SQL 查詢
$Query = "SELECT src, tablename, lastprocessingdatetime FROM dbo.QueueControlDates"

# -----------------------------------------------------------

# 無限迴圈開始
while ($true) {
    Write-Host "--- [$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] Starting History Logging. ---"
    
    $AllSourceData = @()

    # 1. 提取並標記所有來源資料
    # (此段邏輯不變)
    foreach ($Remote in $RemoteServers) {
        try {
            Write-Host "  -> Fetching data from $($Remote.ServerName)"
            $RemoteData = Invoke-Sqlcmd -ServerInstance $Remote.ServerName -Database $Remote.DatabaseName -Query $Query -ErrorAction Stop
            
            $RemoteData | Add-Member -MemberType NoteProperty -Name "PivotColumn" -Value $Remote.PivotColumn -PassThru | Out-Null
            
            $AllSourceData += $RemoteData
        }
        catch {
            Write-Error "Error fetching data from $($Remote.ServerName): $($_.Exception.Message)"
        }
    }

    # 2. 在 PowerShell 中將資料樞紐分析 (Pivot)
    # (此段邏輯不變)
    $PivotedRecords = $AllSourceData | Group-Object -Property @('src', 'tablename') | ForEach-Object {
        
        $Record = [PSCustomObject]@{
            src = $_.Group[0].src
            tablename = $_.Group[0].tablename
            DB_A_Time = $null
            DB_B_Time = $null
        }

        foreach ($Item in $_.Group) {
            if ($Item.PivotColumn -eq $RemoteServers[0].PivotColumn) { # Server A
                $Record.DB_A_Time = $Item.lastprocessingdatetime
            }
            if ($Item.PivotColumn -eq $RemoteServers[1].PivotColumn) { # Server B
                $Record.DB_B_Time = $Item.lastprocessingdatetime
            }
        }
        
        return $Record
    }
    
    Write-Host "  -> Successfully pivoted $($PivotedRecords.Count) unique records for logging."

    # 3. 執行單次資料庫操作 (純粹 INSERT)
    $LocalConn = New-Object System.Data.SqlClient.SqlConnection
    $LocalConn.ConnectionString = "Server=$LocalServer;Database=$LocalDB;Integrated Security=True;" 

    try {
        $LocalConn.Open()
        
        $RowCount = 0
        foreach ($Record in $PivotedRecords) {
            
            # 使用 INSERT 語句 (不再是 MERGE)
            $InsertSql = @"
INSERT INTO dbo.$DestTable (tablename, src, $($RemoteServers[0].PivotColumn), $($RemoteServers[1].PivotColumn), insertdatetime)
VALUES (@table, @src, @time_A, @time_B, GETDATE());
"@
            # 準備並執行指令
            $LocalCmd = New-Object System.Data.SqlClient.SqlCommand
            $LocalCmd.Connection = $LocalConn
            $LocalCmd.CommandText = $InsertSql
            
            # 定義參數
            $LocalCmd.Parameters.Add((New-Object System.Data.SqlClient.SqlParameter -ArgumentList "@src", [System.Data.SqlDbType]::NVarChar, 255)).Value = $Record.src
            $LocalCmd.Parameters.Add((New-Object System.Data.SqlClient.SqlParameter -ArgumentList "@table", [System.Data.SqlDbType]::NVarChar, 255)).Value = $Record.tablename
            # 注意: 如果 $Record.DB_A_Time 是 $null，它將作為 NULL 寫入資料庫
            $LocalCmd.Parameters.Add((New-Object System.Data.SqlClient.SqlParameter -ArgumentList "@time_A", [System.Data.SqlDbType]::DateTime)).Value = $Record.DB_A_Time
            $LocalCmd.Parameters.Add((New-Object System.Data.SqlClient.SqlParameter -ArgumentList "@time_B", [System.Data.SqlDbType]::DateTime)).Value = $Record.DB_B_Time
            
            $LocalCmd.ExecuteNonQuery() | Out-Null
            $RowCount++
        }
        
        Write-Host "  -> Successfully logged $RowCount history records."
    }
    catch {
        Write-Error "Database INSERT failed: $($_.Exception.Message). Retrying after sleep..."
    }
    finally {
        if ($LocalConn -ne $null -and $LocalConn.State -eq [System.Data.ConnectionState]::Open) {
            $LocalConn.Close()
        }
    }
    
    Write-Host "Sleeping for $SleepSeconds seconds..."
    Start-Sleep $SleepSeconds
}
